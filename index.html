<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Mental Math" />

  <link rel="apple-touch-icon" href="icon.png" />
  <link rel="icon" type="image/png" href="icon.png" />

  <title>Mental Math</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b0d12;
      color: #e9eefc;
      overscroll-behavior: none;
      user-select: none;
    }
    .wrap { max-width: 720px; margin: auto; padding: 20px; }
    .card { background: #121726; border-radius: 18px; padding: 18px; }
    h1 { margin: 0 0 10px; }
    button {
      border: none; border-radius: 14px;
      padding: 12px; font-weight: 700;
      cursor: pointer;
    }
    .primary { background: #4f7cff; color: white; }
    .secondary { background: #232b3f; color: white; }
    .screen { display: none; }
    .screen.active { display: block; }
    .problem { font-size: 40px; text-align: center; margin: 20px 0; }
    input { width: 100%; font-size: 20px; padding: 10px; border-radius: 12px; }
    .feedback { text-align: center; height: 24px; font-weight: 700; }
    .ok { color: #43d17a; }
    .bad { color: #ff6b6b; }
  </style>
</head>

<body>
<div class="wrap">

  <!-- MENU -->
  <div id="menu" class="screen active">
    <div class="card">
      <h1>Mental Math</h1>
      <label><input type="checkbox" id="timerMode"> Timer mode (60s)</label><br><br>
      <button class="primary" onclick="startGame()">Start</button>
      <button class="secondary" onclick="showLeaderboard()">Leaderboard</button>
    </div>
  </div>

  <!-- GAME -->
  <div id="game" class="screen">
    <div class="card">
      <button class="secondary" onclick="exitGame()">Exit</button>
      <div id="status"></div>
      <div id="problem" class="problem"></div>
      <input id="answer" inputmode="numeric" />
      <button class="primary" onclick="submitAnswer()">Submit</button>
      <div id="feedback" class="feedback"></div>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderboard" class="screen">
    <div class="card">
      <button class="secondary" onclick="showMenu()">Back</button>
      <h1>Leaderboard</h1>
      <div id="lb"></div>
    </div>
  </div>

</div>

<!-- CELEBRATION -->
<div id="celebrate" style="display:none; position:fixed; inset:0; pointer-events:none;">
  <canvas id="confetti"></canvas>
  <img src="icon.png" id="bounce" style="position:absolute; width:80px;">
</div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, runTransaction, collection, query, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyDONN7TlyRODTneVlM3cbc3IFOxZmg5hkI",
    authDomain: "mental-math-ea932.firebaseapp.com",
    projectId: "mental-math-ea932",
    storageBucket: "mental-math-ea932.firebasestorage.app",
    messagingSenderId: "943851684376",
    appId: "1:943851684376:web:fdfc75f05b26610fe0796d"
  });

  const db = getFirestore(app);

  window.api = {
    async submit(name, score) {
      const ref = doc(db, "bestScores", name.toLowerCase());
      return await runTransaction(db, async tx => {
        const snap = await tx.get(ref);
        if (!snap.exists() || score > snap.data().score) {
          tx.set(ref, { name, score, updatedAt: serverTimestamp() });
          return true;
        }
        return false;
      });
    },
    async leaderboard() {
      const q = query(collection(db, "bestScores"), orderBy("score", "desc"));
      const snap = await getDocs(q);
      return snap.docs.map(d => d.data());
    }
  };
</script>

<script>
let score = 0, streak = 0, time = 60, timer;

function show(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function startGame() {
  score = 0; streak = 0; time = 60;
  show("game");
  next();
  if (timerMode.checked) {
    timer = setInterval(() => {
      time--;
      if (time <= 0) endTimer();
    }, 1000);
  }
}

function exitGame() {
  clearInterval(timer);
  show("menu");
}

function next() {
  const a = Math.floor(Math.random()*20)+1;
  const b = Math.floor(Math.random()*20)+1;
  window.answerVal = a + b;
  problem.textContent = `${a} + ${b}`;
  answer.value = "";
  status.textContent = `Score: ${score}`;
}

function submitAnswer() {
  if (+answer.value === answerVal) {
    feedback.textContent = "Correct!";
    feedback.className = "feedback ok";
    score++;
    next();
  } else {
    feedback.textContent = "Incorrect";
    feedback.className = "feedback bad";
  }
}

async function endTimer() {
  clearInterval(timer);
  const name = prompt("Enter name");
  const isPB = await window.api.submit(name || "anon", score);
  if (isPB) celebrate();
  showLeaderboard();
}

async function showLeaderboard() {
  show("leaderboard");
  const rows = await window.api.leaderboard();
  lb.innerHTML = rows.map(r => `<div>${r.name}: ${r.score}</div>`).join("");
}

function showMenu() { show("menu"); }

function celebrate() {
  const box = document.getElementById("celebrate");
  const img = document.getElementById("bounce");
  box.style.display = "block";
  let x=20,y=20,vx=8,vy=6;
  const i = setInterval(()=> {
    x+=vx;y+=vy;
    if (x<0||x>innerWidth-80) vx*=-1;
    if (y<0||y>innerHeight-80) vy*=-1;
    img.style.transform=`translate(${x}px,${y}px)`;
  },16);
  setTimeout(()=>{clearInterval(i);box.style.display="none";},2000);
}
</script>
</body>
</html>
