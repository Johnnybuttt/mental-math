<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Mental Math" />

  <link rel="apple-touch-icon" href="icon.png" />
  <link rel="icon" type="image/png" href="icon.png" />

  <title>Mental Math</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b0d12;
      color: #e9eefc;
      overscroll-behavior: none;
      user-select: none;
    }
    .wrap { max-width: 720px; margin: auto; padding: 20px; }
    .card { background: #121726; border-radius: 18px; padding: 18px; }
    h1 { margin: 0 0 10px; }
    button {
      border: none; border-radius: 14px;
      padding: 12px; font-weight: 700;
      cursor: pointer;
    }
    .primary { background: #4f7cff; color: white; }
    .secondary { background: #232b3f; color: white; }
    .screen { display: none; }
    .screen.active { display: block; }
    .problem { font-size: 40px; text-align: center; margin: 20px 0; }
    input { width: 100%; font-size: 20px; padding: 10px; border-radius: 12px; }
    .feedback { text-align: center; height: 24px; font-weight: 700; }
    .ok { color: #43d17a; }
    .bad { color: #ff6b6b; }
  </style>
</head>

<body>
<div class="wrap">

  <!-- MENU -->
  <div id="menu" class="screen active">
    <div class="card">
      <h1>Mental Math</h1>
      <label><input type="checkbox" id="timerMode"> Timer mode (60s)</label><br><br>
      <button class="primary" onclick="startGame()">Start</button>
      <button class="secondary" onclick="showLeaderboard()">Leaderboard</button>
    </div>
  </div>

  <!-- GAME -->
  <div id="game" class="screen">
    <div class="card">
      <button class="secondary" onclick="exitGame()">Exit</button>
      <div id="status"></div>
      <div id="problem" class="problem"></div>
      <input id="answer" inputmode="numeric" />
      <button class="primary" onclick="submitAnswer()">Submit</button>
      <div id="feedback" class="feedback"></div>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderboard" class="screen">
    <div class="card">
      <button class="secondary" onclick="showMenu()">Back</button>
      <h1>Leaderboard</h1>
      <div id="lb"></div>
    </div>
  </div>

</div>

<!-- CELEBRATION -->
<div id="celebrate" style="display:none; position:fixed; inset:0; pointer-events:none;">
  <canvas id="confetti"></canvas>
  <img src="icon.png" id="bounce" style="position:absolute; width:80px;">
</div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, runTransaction, collection, query, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyDONN7TlyRODTneVlM3cbc3IFOxZmg5hkI",
    authDomain: "mental-math-ea932.firebaseapp.com",
    projectId: "mental-math-ea932",
    storageBucket: "mental-math-ea932.firebasestorage.app",
    messagingSenderId: "943851684376",
    appId: "1:943851684376:web:fdfc75f05b26610fe0796d"
  });

  const db = getFirestore(app);

  window.api = {
    async submit(name, score) {
      const ref = doc(db, "bestScores", name.toLowerCase());
      return await runTransaction(db, async tx => {
        const snap = await tx.get(ref);
        if (!snap.exists() || score > snap.data().score) {
          tx.set(ref, { name, score, updatedAt: serverTimestamp() });
          return true;
        }
        return false;
      });
    },
    async leaderboard() {
      const q = query(collection(db, "bestScores"), orderBy("score", "desc"));
      const snap = await getDocs(q);
      return snap.docs.map(d => d.data());
    }
  };
</script>

<script>
let score = 0, streak = 0, time = 60, timer;

function show(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function startGame() {
  score = 0; streak = 0; time = 60;
  show("game");
  next();
  if (timerMode.checked) {
    timer = setInterval(() => {
      time--;
      if (time <= 0) endTimer();
    }, 1000);
  }
}

function exitGame() {
  clearInterval(timer);
  show("menu");
}

function next() {
  const a = Math.floor(Math.random()*20)+1;
  const b = Math.floor(Math.random()*20)+1;
  window.answerVal = a + b;
  problem.textContent = `${a} + ${b}`;
  answer.value = "";
  status.textContent = `Score: ${score}`;
}

function submitAnswer() {
  if (+answer.value === answerVal) {
    feedback.textContent = "Correct!";
    feedback.className = "feedback ok";
    score++;
    next();
  } else {
    feedback.textContent = "Incorrect";
    feedback.className = "feedback bad";
  }
}

async function endTimer() {
  clearInterval(timer);
  const name = prompt("Enter name");
  const isPB = await window.api.submit(name || "anon", score);
  if (isPB) celebrate();
  showLeaderboard();
}

async function showLeaderboard() {
  show("leaderboard");
  const rows = await window.api.leaderboard();
  lb.innerHTML = rows.map(r => `<div>${r.name}: ${r.score}</div>`).join("");
}

function showMenu() { show("menu"); }

function celebrate(durationMs = 2000) {
  const overlay = document.getElementById("celebrate");
  const canvas = document.getElementById("confetti");
  const img = document.getElementById("bounce");
  const ctx = canvas.getContext("2d");

  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  resize();

  overlay.style.display = "block";

  // bouncing icon
  let x = 20, y = 20;
  let vx = 10, vy = 8;
  const size = 80;

  // confetti particles
  const colors = ["#ff6b6b", "#4f7cff", "#43d17a", "#ffd166", "#c77dff", "#ffffff"];
  const parts = [];
  for (let i = 0; i < 200; i++) {
    parts.push({
      x: Math.random() * canvas.width,
      y: Math.random() * -canvas.height,
      vx: (Math.random() - 0.5) * 3,
      vy: 4 + Math.random() * 7,
      r: 2 + Math.random() * 5,
      rot: Math.random() * Math.PI,
      vr: (Math.random() - 0.5) * 0.25,
      c: colors[Math.floor(Math.random() * colors.length)]
    });
  }

  const start = performance.now();

  function frame(now) {
    const t = now - start;

    // bounce
    x += vx; y += vy;
    const maxX = window.innerWidth - size;
    const maxY = window.innerHeight - size;
    if (x <= 0) { x = 0; vx *= -1; }
    if (y <= 0) { y = 0; vy *= -1; }
    if (x >= maxX) { x = maxX; vx *= -1; }
    if (y >= maxY) { y = maxY; vy *= -1; }
    img.style.transform = `translate(${x}px, ${y}px)`;

    // confetti
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (const p of parts) {
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;

      // wrap
      if (p.y > canvas.height + 20) {
        p.y = -20;
        p.x = Math.random() * canvas.width;
      }
      if (p.x < -20) p.x = canvas.width + 20;
      if (p.x > canvas.width + 20) p.x = -20;

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.c;
      ctx.fillRect(-p.r, -p.r, p.r * 2, p.r * 2);
      ctx.restore();
    }

    if (t < durationMs) {
      requestAnimationFrame(frame);
    } else {
      overlay.style.display = "none";
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      window.removeEventListener("resize", resize);
    }
  }

  window.addEventListener("resize", resize, { passive: true });
  requestAnimationFrame(frame);
}

</script>
</body>
</html>
