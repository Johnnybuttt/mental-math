<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Mental Math" />

  <link rel="apple-touch-icon" href="icon.png" />
  <link rel="icon" type="image/png" href="icon.png" />

  <title>Mental Math</title>

  <style>
    html, body { margin: 0; height: 100%; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b0d12;
      color: #e9eefc;
      overscroll-behavior: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .wrap { max-width: 720px; margin: 0 auto; padding: 20px; }
    .card {
      background: #121726;
      border: 1px solid #232b3f;
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    h1 { margin: 0 0 10px; font-size: 28px; }
    .muted { color: #a8b3d6; }

    .screen { display: none; }
    .screen.active { display: block; }

    .grid { display: grid; gap: 10px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }

    label.chk {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid #232b3f;
      border-radius: 14px;
      background: #0f1422;
      cursor: pointer;
    }

    input[type="checkbox"] { width: 18px; height: 18px; }

    button {
      border: 0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      cursor: pointer;
      touch-action: manipulation;
    }
    .primary { background: #4f7cff; color: white; }
    .secondary { background: #232b3f; color: #e9eefc; }

    .pill {
      font-size: 12px;
      padding: 6px 10px;
      border: 1px solid #232b3f;
      border-radius: 999px;
      background: #0f1422;
      color: #a8b3d6;
      white-space: nowrap;
    }

    .topbar { display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px; }

    .problem { font-size: 44px; font-weight: 900; text-align: center; margin: 18px 0 10px; }

    input.answer {
      width: 100%;
      font-size: 20px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid #232b3f;
      background: #0f1422;
      color: #e9eefc;
      outline: none;
      box-sizing: border-box;
    }

    .feedback { height: 26px; text-align: center; font-weight: 800; margin-top: 10px; }
    .ok { color: #43d17a; }
    .bad { color: #ff6b6b; }

    /* Leaderboard rows */
    .lbRow {
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 12px 12px;
      border: 1px solid #232b3f;
      border-radius: 14px;
      background: #0f1422;
    }
    .lbLeft { display:flex; flex-direction: column; gap: 2px; min-width: 0; }
    .lbName { font-weight: 900; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 420px; }
    .lbMeta { font-size: 12px; color: #a8b3d6; }
    .lbScore { font-weight: 900; font-size: 18px; }

    /* Timer modal */
    #modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      z-index: 9998;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    #modal .card { max-width: 520px; width: 100%; }
    input.name {
      width: 100%;
      font-size: 18px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid #232b3f;
      background: #0f1422;
      color: #e9eefc;
      box-sizing: border-box;
      outline: none;
    }
    .big { font-size: 34px; font-weight: 1000; text-align:center; margin: 10px 0; }

    /* Celebration overlay */
    #celebrate {
      display: none;
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
    }
    #confetti {
      position: absolute;
      inset: 0;
    }
    /* 1) DOUBLE SIZE (was 96px, now 192px) */
    #bounce {
      position: absolute;
      width: 192px;
      height: 192px;
      left: 20px;
      top: 20px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- MENU -->
    <div id="menu" class="screen active">
      <div class="card">
        <h1>Mental Math</h1>
        <div class="muted">Choose problem types. Timer mode is always 60 seconds.</div>

        <!-- 2/3) All modes back -->
        <div class="grid" style="margin-top:14px;">
          <label class="chk"><input type="checkbox" id="add" checked /> Add</label>
          <label class="chk"><input type="checkbox" id="sub" /> Subtract</label>
          <label class="chk"><input type="checkbox" id="mul" /> Multiply</label>
          <label class="chk"><input type="checkbox" id="div" /> Divide</label>
          <label class="chk"><input type="checkbox" id="pct" /> Percent</label>
        </div>

        <!-- 4) Timer is only 60 seconds -->
        <div class="grid" style="margin-top:14px;">
          <label class="chk">
            <input type="checkbox" id="timerMode" />
            Timer mode (60 seconds)
          </label>
        </div>

        <div class="row" style="margin-top:14px;">
          <button id="startBtn" class="primary" style="flex:1;">Start</button>
          <button id="leaderBtn" class="secondary" style="flex:1;">Leaderboard</button>
        </div>

        <div class="muted" style="margin-top:12px; font-size: 13px;">
          iPhone tip: open in Safari → Share → Add to Home Screen.
        </div>
      </div>
    </div>

    <!-- GAME -->
    <div id="game" class="screen">
      <div class="card">
        <div class="topbar">
          <button id="exitBtn" class="secondary">Exit</button>
          <div id="statusPill" class="pill">Streak: 0 | Best: 0</div>
          <div style="width:64px;"></div>
        </div>

        <div id="problem" class="problem">Loading…</div>

        <input id="answer" class="answer" inputmode="decimal" placeholder="Type answer" autocomplete="off" />

        <div class="row" style="margin-top:12px;">
          <button id="submitBtn" class="primary" style="flex:1;">Submit</button>
        </div>

        <div id="feedback" class="feedback"></div>
      </div>
    </div>

    <!-- LEADERBOARD -->
    <div id="leaderboard" class="screen">
      <div class="card">
        <div class="topbar">
          <button id="backBtn" class="secondary">Back</button>
          <div class="pill">Best score per name</div>
          <div style="width:64px;"></div>
        </div>

        <div class="row" style="margin-bottom:10px;">
          <button id="refreshBtn" class="secondary" style="flex:1;">Refresh</button>
        </div>

        <div id="lbStatus" class="muted" style="margin-bottom:10px; font-size: 13px;"></div>
        <div id="lbList" class="grid"></div>
      </div>
    </div>

  </div>

  <!-- TIMER END MODAL -->
  <div id="modal">
    <div class="card">
      <div class="muted" style="text-align:center;">Time’s up</div>
      <div class="big" id="finalScore">Score: 0</div>

      <div class="muted" style="text-align:center; margin: 6px 0 10px;">
        Enter your name to post your best score.
      </div>

      <input id="nameInput" class="name" maxlength="20" placeholder="Your name (max 20)" />

      <div class="row" style="margin-top:12px;">
        <button class="primary" id="postBtn" style="flex:1;">Post Score</button>
        <button class="secondary" id="skipBtn" style="flex:1;">Skip</button>
      </div>

      <div id="postStatus" class="muted" style="text-align:center; margin-top:10px; min-height: 18px;"></div>

      <div class="row" style="margin-top:12px;">
        <button class="primary" id="restartBtn" style="flex:1;">Restart</button>
        <button class="secondary" id="exitBtn2" style="flex:1;">Exit</button>
      </div>
    </div>
  </div>

  <!-- CELEBRATION OVERLAY -->
  <div id="celebrate">
    <canvas id="confetti"></canvas>
    <img id="bounce" src="icon.png" alt="celebrate" />
  </div>

  <!-- FIREBASE (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      doc,
      runTransaction,
      collection,
      query,
      orderBy,
      limit,
      getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDONN7TlyRODTneVlM3cbc3IFOxZmg5hkI",
      authDomain: "mental-math-ea932.firebaseapp.com",
      projectId: "mental-math-ea932",
      storageBucket: "mental-math-ea932.firebasestorage.app",
      messagingSenderId: "943851684376",
      appId: "1:943851684376:web:fdfc75f05b26610fe0796d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function toNameKey(name) {
      return String(name || "")
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "")
        .slice(0, 50) || "anonymous";
    }

    window.api = {
      // Returns: { updated: true/false, previous: number }
      async submitBestScore(name, score) {
        const cleanName = String(name || "").trim().slice(0, 20) || "Anonymous";
        const nameKey = toNameKey(cleanName);
        const cleanScore = Math.max(0, Math.floor(Number(score) || 0));

        const ref = doc(db, "bestScores", nameKey);

        const result = await runTransaction(db, async (tx) => {
          const snap = await tx.get(ref);

          if (!snap.exists()) {
            tx.set(ref, { name: cleanName, nameKey, score: cleanScore, updatedAt: serverTimestamp() });
            return { updated: true, previous: 0 };
          }

          const prev = Number(snap.data().score) || 0;

          if (cleanScore > prev) {
            tx.set(ref, { name: cleanName, nameKey, score: cleanScore, updatedAt: serverTimestamp() }, { merge: true });
            return { updated: true, previous: prev };
          }

          return { updated: false, previous: prev };
        });

        return result;
      },

      async topScores(max = 20) {
        const q = query(collection(db, "bestScores"), orderBy("score", "desc"), limit(max));
        const snap = await getDocs(q);
        return snap.docs.map(d => d.data());
      }
    };
  </script>

  <!-- APP LOGIC -->
  <script>
    // Screens
    const menu = document.getElementById("menu");
    const game = document.getElementById("game");
    const leaderboard = document.getElementById("leaderboard");

    // Menu controls
    const add = document.getElementById("add");
    const sub = document.getElementById("sub");
    const mul = document.getElementById("mul");
    const div = document.getElementById("div");
    const pct = document.getElementById("pct");
    const timerMode = document.getElementById("timerMode");

    const startBtn = document.getElementById("startBtn");
    const leaderBtn = document.getElementById("leaderBtn");

    // Game controls
    const exitBtn = document.getElementById("exitBtn");
    const submitBtn = document.getElementById("submitBtn");
    const statusPill = document.getElementById("statusPill");
    const problemEl = document.getElementById("problem");
    const answerEl = document.getElementById("answer");
    const feedbackEl = document.getElementById("feedback");

    // Leaderboard controls
    const backBtn = document.getElementById("backBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const lbStatus = document.getElementById("lbStatus");
    const lbList = document.getElementById("lbList");

    // Modal
    const modal = document.getElementById("modal");
    const finalScore = document.getElementById("finalScore");
    const nameInput = document.getElementById("nameInput");
    const postBtn = document.getElementById("postBtn");
    const skipBtn = document.getElementById("skipBtn");
    const postStatus = document.getElementById("postStatus");
    const restartBtn = document.getElementById("restartBtn");
    const exitBtn2 = document.getElementById("exitBtn2");

    // Celebration
    const celebrateOverlay = document.getElementById("celebrate");
    const confettiCanvas = document.getElementById("confetti");
    const bounceImg = document.getElementById("bounce");

    // State
    let selectedTypes = ["add"];
    let currentAnswer = 0;

    let streak = 0;
    let bestStreak = Number(localStorage.getItem("bestStreak") || 0);

    let isTimer = false;
    let score = 0;
    let timeLeft = 60;      // 4) fixed
    let timerId = null;

    function showScreen(id) {
      [menu, game, leaderboard].forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function pick(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function nearlyEqual(a, b, eps = 1e-6) {
      return Math.abs(a - b) < eps;
    }

    function readSelectedTypes() {
      const types = [];
      if (add.checked) types.push("add");
      if (sub.checked) types.push("sub");
      if (mul.checked) types.push("mul");
      if (div.checked) types.push("div");
      if (pct.checked) types.push("pct");
      return types.length ? types : ["add"];
    }

    // 2/3) Full problem generator
    function generateProblem() {
      const t = pick(selectedTypes);

      if (t === "add") {
        const a = randInt(1, 99), b = randInt(1, 99);
        return { prompt: `${a} + ${b}`, answer: a + b };
      }

      if (t === "sub") {
        const a = randInt(1, 99), b = randInt(1, 99);
        return { prompt: `${a} − ${b}`, answer: a - b };
      }

      if (t === "mul") {
        const a = randInt(2, 20), b = randInt(2, 20);
        return { prompt: `${a} × ${b}`, answer: a * b };
      }

      if (t === "div") {
        const b = randInt(2, 20);
        const ans = randInt(2, 20);
        return { prompt: `${b * ans} ÷ ${b}`, answer: ans };
      }

      if (t === "pct") {
        const options = [5, 10, 12.5, 15, 20, 25, 30, 40, 50, 75];
        const p = pick(options);
        const base = randInt(20, 200);
        return { prompt: `${p}% of ${base}`, answer: (p / 100) * base };
      }

      // fallback
      return { prompt: "1 + 1", answer: 2 };
    }

    function updateStatus() {
      if (!isTimer) {
        statusPill.textContent = `Streak: ${streak} | Best: ${bestStreak}`;
      } else {
        statusPill.textContent = `Time: ${timeLeft}s | Score: ${score}`;
      }
    }

    function newProblem() {
      const p = generateProblem();
      currentAnswer = p.answer;
      problemEl.textContent = p.prompt;

      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";

      answerEl.value = "";
      answerEl.focus();

      updateStatus();
    }

    function stopTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
    }

    function startTimer60() {
      stopTimer();
      timeLeft = 60;
      updateStatus();

      timerId = setInterval(() => {
        timeLeft -= 1;
        updateStatus();
        if (timeLeft <= 0) {
          stopTimer();
          endTimer();
        }
      }, 1000);
    }

    function startGame() {
      selectedTypes = readSelectedTypes();
      isTimer = timerMode.checked;

      score = 0;
      streak = 0;

      showScreen("game");

      if (isTimer) startTimer60();
      else stopTimer();

      newProblem();
    }

    function exitGame() {
      stopTimer();
      closeModal();
      showScreen("menu");
      updateStatus();
    }

    function submitAnswer() {
      const raw = answerEl.value.trim();
      if (!raw) return;

      const val = Number(raw.replace(",", "."));
      const ok = Number.isFinite(val) && nearlyEqual(val, currentAnswer, 1e-4);

      if (ok) {
        feedbackEl.textContent = "Correct!";
        feedbackEl.className = "feedback ok";

        if (isTimer) {
          score++;
        } else {
          streak++;
          if (streak > bestStreak) {
            bestStreak = streak;
            localStorage.setItem("bestStreak", String(bestStreak));
          }
        }

        updateStatus();
        setTimeout(newProblem, 120);
      } else {
        feedbackEl.textContent = "Incorrect";
        feedbackEl.className = "feedback bad";

        if (!isTimer) {
          streak = 0;
          updateStatus();
        }

        answerEl.value = "";
        answerEl.focus();
      }
    }

    // Modal logic
    function openModal() {
      modal.style.display = "flex";
      postStatus.textContent = "";
      finalScore.textContent = `Score: ${score}`;
      nameInput.value = localStorage.getItem("lastName") || "";
      nameInput.focus();
    }

    function closeModal() {
      modal.style.display = "none";
      postStatus.textContent = "";
    }

    function endTimer() {
      openModal();
    }

    async function postScore() {
      postBtn.disabled = true;
      postStatus.textContent = "Posting…";

      try {
        const name = (nameInput.value || "").trim().slice(0, 20) || "Anonymous";
        localStorage.setItem("lastName", name);

        const res = await window.api.submitBestScore(name, score);

        if (res && res.updated && score > (res.previous || 0)) {
          runPersonalBestCelebration(2000);
          postStatus.textContent = "New personal best!";
        } else {
          postStatus.textContent = "Posted (or not higher than your best).";
        }

        setTimeout(async () => {
          closeModal();
          showScreen("leaderboard");
          await loadLeaderboard();
          postBtn.disabled = false;
          postStatus.textContent = "";
        }, 500);
      } catch (e) {
        console.error(e);
        postStatus.textContent = "Post failed. Check Firestore rules.";
        postBtn.disabled = false;
      }
    }

    async function loadLeaderboard() {
      lbStatus.textContent = "Loading…";
      lbList.innerHTML = "";

      try {
        const rows = await window.api.topScores(20);
        lbStatus.textContent = rows.length ? "" : "No scores yet.";

        rows.forEach((r, i) => {
          const el = document.createElement("div");
          el.className = "lbRow";

          const left = document.createElement("div");
          left.className = "lbLeft";

          const nm = document.createElement("div");
          nm.className = "lbName";
          nm.textContent = `${i + 1}. ${r.name || "Anonymous"}`;

          const meta = document.createElement("div");
          meta.className = "lbMeta";
          meta.textContent = "Best score";

          const right = document.createElement("div");
          right.className = "lbScore";
          right.textContent = String(Number(r.score) || 0);

          left.appendChild(nm);
          left.appendChild(meta);
          el.appendChild(left);
          el.appendChild(right);

          lbList.appendChild(el);
        });
      } catch (e) {
        console.error(e);
        lbStatus.textContent = "Could not load leaderboard.";
      }
    }

    // 1) Celebration: bounce + confetti (2 seconds) with 2x image size
    function runPersonalBestCelebration(durationMs = 2000) {
      const overlay = celebrateOverlay;
      const canvas = confettiCanvas;
      const img = bounceImg;
      const ctx = canvas.getContext("2d");

      function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      resize();
      overlay.style.display = "block";

      // Bounce: match CSS size (192)
      let x = 20, y = 20;
      let vx = 11, vy = 9;
      const imgSize = 192;

      // Confetti
      const colors = ["#ff6b6b", "#4f7cff", "#43d17a", "#ffd166", "#c77dff", "#ffffff"];
      const confetti = [];
      for (let i = 0; i < 220; i++) {
        confetti.push({
          x: Math.random() * canvas.width,
          y: -Math.random() * canvas.height,
          vx: (Math.random() - 0.5) * 3,
          vy: 4 + Math.random() * 7,
          size: 4 + Math.random() * 7,
          rot: Math.random() * Math.PI,
          vr: (Math.random() - 0.5) * 0.25,
          color: colors[Math.floor(Math.random() * colors.length)]
        });
      }

      const start = performance.now();

      function frame(now) {
        const t = now - start;

        // bounce
        x += vx;
        y += vy;
        const maxX = window.innerWidth - imgSize;
        const maxY = window.innerHeight - imgSize;

        if (x <= 0) { x = 0; vx *= -1; }
        if (y <= 0) { y = 0; vy *= -1; }
        if (x >= maxX) { x = maxX; vx *= -1; }
        if (y >= maxY) { y = maxY; vy *= -1; }

        img.style.transform = `translate(${x}px, ${y}px)`;

        // confetti
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (const p of confetti) {
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;

          if (p.y > canvas.height + 20) {
            p.y = -20;
            p.x = Math.random() * canvas.width;
          }
          if (p.x < -20) p.x = canvas.width + 20;
          if (p.x > canvas.width + 20) p.x = -20;

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
          ctx.restore();
        }

        if (t < durationMs) {
          requestAnimationFrame(frame);
        } else {
          overlay.style.display = "none";
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          window.removeEventListener("resize", resize);
        }
      }

      window.addEventListener("resize", resize, { passive: true });
      requestAnimationFrame(frame);
    }

    // Events
    startBtn.addEventListener("click", startGame);

    leaderBtn.addEventListener("click", async () => {
      showScreen("leaderboard");
      await loadLeaderboard();
    });

    exitBtn.addEventListener("click", exitGame);
    exitBtn2.addEventListener("click", exitGame);

    submitBtn.addEventListener("click", submitAnswer);
    answerEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") submitAnswer();
    });

    backBtn.addEventListener("click", () => showScreen("menu"));
    refreshBtn.addEventListener("click", loadLeaderboard);

    postBtn.addEventListener("click", postScore);
    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") postScore();
    });

    skipBtn.addEventListener("click", () => closeModal());
    restartBtn.addEventListener("click", () => {
      closeModal();
      startGame();
    });

    // Init
    updateStatus();
  </script>
</body>
</html>
